name: Publish @rocketc/react to npm

on:
  # 手动触发，可以选择版本类型
  workflow_dispatch:
    inputs:
      version_type:
        description: '版本类型 (patch/minor/major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      tag:
        description: '标签 (alpha/beta/rc/latest/next)'
        required: false
        default: 'alpha'
        type: choice
        options:
          - alpha
          - beta
          - rc
          - latest
          - next
  # 通过推送 tag 触发（格式：react-v1.0.0）
  push:
    tags:
      - 'react-v*'

jobs:
  extract-version-from-tag:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Extract version from tag
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/react-v* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#react-v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: extract-version-from-tag
    permissions:
      contents: write
      id-token: write
    uses: ./.github/workflows/publish-package.yml
    with:
      package_name: '@rocketc/react'
      package_path: 'packages/libs/react'
      tag_prefix: 'react-v'
      version_type: ${{ github.event.inputs.version_type }}
      version_from_tag: ${{ needs.extract-version-from-tag.outputs.version }}
      npm_tag: ${{ github.event.inputs.tag || 'alpha' }}
      pre_build_steps: 'pnpm run install-components,pnpm run gen-entry'
      run_tests: false
      commit_message_prefix: 'react'
      create_tag: ${{ github.event_name == 'workflow_dispatch' }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
